#!/usr/bin/python

import subprocess
from pathlib import Path
import json
import pickle
import time
import threading
import os

OUT = f"{Path.home()}/.config/hypr/store/dynamic_out.txt"
prev = None

# Эта функция сама делает json.dumps, поэтому внутрь передаем только словари (dict)
def print_json(ar):
    with open(OUT, "w") as f:
        f.write(json.dumps(ar))

global PAUSE_MEDIA
PAUSE_MEDIA = False

def notif_watcher():
    global prev
    global PAUSE_MEDIA
    
    # Создаем заглушку, если файла нет
    if not os.path.exists(f"{Path.home()}/.config/hypr/store/latest_notif"):
         return

    with open(f"{Path.home()}/.config/hypr/store/latest_notif", "rb") as f:
        try:
            new = pickle.load(f)
        except:
            new = prev
        
        if new != prev:
                # ИСПРАВЛЕНО: убрал json.dumps, передаем словарь
                print_json({"class": "none", "text": ""})
                
                PAUSE_MEDIA = True
                urgency = "low"
                if new.get("urgency") == "CRITICAL":
                    urgency = "critical"
                elif new.get("urgency") == "NORMAL":
                    urgency = "normal"
                
                doc = {
                        "class": urgency,
                        "text": f'[{new["app_name"]}]   {new["summary"]}',
                        "tooltip": "notification"
                }
                print_json(doc)
                time.sleep(3)
                
                # ИСПРАВЛЕНО: просто словарь
                print_json({"class": "none", "text": ""})
                
                PAUSE_MEDIA = False
                prev = new


def start_watcher():
    while 1:
        notif_watcher()
        time.sleep(0.5)


def debug():
    while 1:
        # print(PAUSE_MEDIA) # debug print лучше закомментировать для продакшена
        time.sleep(0.5)

t = threading.Thread(target=start_watcher)
# d = threading.Thread(target=debug)
t.start()
# d.start()

# ИСПРАВЛЕНО: Инициализация файла при старте
print_json({"class": "none", "text": ""})

# Проверяем наличие waybar-mpris перед запуском, чтобы скрипт не падал
try:
    process = subprocess.Popen(
        "waybar-mpris --position --autofocus".split(),
        stdout=subprocess.PIPE
    )
    
    for line in iter(lambda: process.stdout.readline().decode("utf-8"), ""):
        if not line:
            break
            
        try:
            dat = json.loads(line)
            if not PAUSE_MEDIA:
                if "text" in dat:
                    dat["text"] = dat["text"].replace(" ", "").replace("", "")
                    print_json(dat)
                else:
                    print_json({"class": "none", "text": ""})
        except json.JSONDecodeError:
            continue
            
except FileNotFoundError:
    # Если waybar-mpris не установлен, пишем пустой статус, чтобы Waybar не ругался
    while True:
        print_json({"class": "error", "text": "Install waybar-mpris"})
        time.sleep(10)

t.join()
